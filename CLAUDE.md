# CLAUDE.md — reqdrive

## What is reqdrive?

Requirements-driven development pipeline. A Bash CLI that automates the flow from markdown requirement documents to GitHub pull requests using Claude Code as the AI agent.

**Version:** 0.3.0 (schema version 0.3.0)

## Architecture

```
bin/reqdrive          CLI entry point — argument parsing, command dispatch
lib/
  errors.sh           Exit codes (0-8) and die/die_on_error helpers
  schema.sh           Schema version checking + JSON validation (config, PRD, checkpoint)
  config.sh           Find reqdrive.json (walks up), export REQDRIVE_* env vars
  sanitize.sh         Input sanitization (prompts, labels, content, file paths)
  preflight.sh        Pre-run safety checks (clean tree, branch, req file exists)
  run.sh              Core pipeline: planning phase → implementation loop → PR
  pr-create.sh        Build and submit GitHub PR with validation checklist
  init.sh             Interactive setup wizard — creates reqdrive.json + directories
  validate.sh         Config validation command
templates/
  reqdrive.json.example   Example configuration
tests/
  simple-test.sh      Primary test suite (106 tests, no external dependencies)
  run-tests.sh        Full test suite runner (requires bats-core)
  fixtures/           JSON fixtures for schema validation tests
  BEHAVIOR-SPEC.md    Behavioral contract for modules 1-4
skills/               Claude Code skills (design-to-prd, prd, project-journal, verification-workflow)
archive/              Archived v0.1.x code (parallel execution, worktrees, etc.)
```

## Pipeline Flow

1. **Pre-flight checks** — clean working tree, base branch exists, requirement file found
2. **Branch creation** — `reqdrive/<req-slug>` from base branch
3. **Phase 1: Planning** — Claude generates `prd.json` with user stories (up to 2 attempts)
4. **Phase 2: Implementation** — One Claude invocation per story, deterministic selection by priority
5. **PR creation** — Push branch, create GitHub PR with validation checklist from PRD

## Key Files and State

- **Config:** `reqdrive.json` at project root (found by walking up directory tree)
- **Run state:** `.reqdrive/runs/<req-slug>/` per requirement
  - `run.json` — lifecycle status, PID, timestamps, PR URL
  - `prd.json` — PRD with user stories (generated by agent)
  - `checkpoint.json` — resume state (iteration, branch, completed stories)
  - `progress.txt` — agent progress log
  - `prompt.md` — current iteration prompt
  - `iteration-N.log` — raw agent output per iteration
  - `iteration-N.summary.json` — structured summary per iteration
  - `output.log` — stdout/stderr capture for `launch` command

## Commands

| Command | Description |
|---------|-------------|
| `init` | Interactive setup — creates `reqdrive.json` and directories |
| `run <REQ-ID>` | Foreground pipeline (supports `--interactive`, `--unsafe`, `--force`, `--resume`) |
| `launch <REQ-ID>` | Detached background run (nohup + `--unsafe`) |
| `status [REQ-ID]` | Show run status with PID liveness checking |
| `logs <REQ-ID>` | Tail `output.log` for a background run |
| `validate` | Validate `reqdrive.json` config |
| `migrate` | Add version fields to pre-0.3.0 configs/PRDs |
| `plan` | Coming soon — standalone PRD generation |
| `orchestrate` | Coming soon — multi-requirement sequencing |

## Configuration (`reqdrive.json`)

| Field | Default | Type |
|-------|---------|------|
| `version` | — | string (`"0.3.0"`) |
| `requirementsDir` | `"docs/requirements"` | string |
| `testCommand` | `""` | string |
| `model` | `"claude-sonnet-4-20250514"` | string |
| `maxIterations` | `10` | number |
| `baseBranch` | `"main"` | string |
| `prLabels` | `["agent-generated"]` | array |
| `projectName` | `""` | string |
| `completionHook` | `""` | string (shell command) |

## Exit Codes

| Code | Name | Meaning |
|------|------|---------|
| 0 | `EXIT_SUCCESS` | Success |
| 1 | `EXIT_GENERAL_ERROR` | General error |
| 2 | `EXIT_MISSING_DEPENDENCY` | Missing required tool |
| 3 | `EXIT_CONFIG_ERROR` | Configuration error |
| 4 | `EXIT_GIT_ERROR` | Git operation failed |
| 5 | `EXIT_AGENT_ERROR` | Agent execution failed |
| 6 | `EXIT_PR_ERROR` | PR creation failed |
| 7 | `EXIT_USER_ABORT` | User aborted |
| 8 | `EXIT_PREFLIGHT_FAILED` | Pre-flight checks failed |

## Development Conventions

- **Shell scripts:** Always use `set -euo pipefail` (entry) or `set -e` (libraries)
- **Syntax check:** Run `bash -n <file>` on all modified `.sh` files before committing
- **Tests:** Run `bash tests/simple-test.sh` — all 106 tests must pass
- **No Co-Authored-By** in commit messages
- **Schema version** `0.3.0` must be set in new JSON outputs (PRD, checkpoint, config)
- **Sanitization:** All user/agent-provided content must go through `sanitize_for_prompt` before heredoc expansion. Labels go through `sanitize_label`.
- **Preflight checks** run by default; `--force` bypasses them

## Testing

```bash
# Primary test suite (no external deps, runs everywhere)
bash tests/simple-test.sh

# Full suite with bats (if available)
bash tests/run-tests.sh
```

Tests cover: config loading, schema validation, sanitization, error codes, preflight checks, iteration summary extraction, prompt injection protection, and CLI behavior.

## Prerequisites

- `bash` 4.0+
- `jq`
- `git`
- `gh` (GitHub CLI, authenticated)
- `claude` (Claude Code CLI — only needed for `run`/`launch` commands)

## Security Notes

- `--unsafe` mode (`--dangerously-skip-permissions`) grants the agent unrestricted system access
- `launch` always uses `--unsafe` mode
- Requirement content is scanned for dangerous patterns (shell injection, path traversal)
- PRD-derived fields are sanitized before heredoc expansion to prevent injection
- Content validation is warn-only by default; use `--force` to bypass entirely
