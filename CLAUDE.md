# CLAUDE.md — reqdrive

## What is reqdrive?

Requirements-driven development pipeline. A Bash CLI that automates the flow from markdown requirement documents to GitHub pull requests using Claude Code as the AI agent.

**Version:** 0.3.0 (schema version 0.3.0)

## Architecture

```
bin/reqdrive          CLI entry point — argument parsing, command dispatch
lib/
  errors.sh           Exit codes (0-8) and die/die_on_error helpers
  schema.sh           Schema version checking + JSON validation (config, PRD, checkpoint)
  config.sh           Find reqdrive.json (walks up), export REQDRIVE_* env vars
  sanitize.sh         Input sanitization (prompts, labels, content, file paths)
  preflight.sh        Pre-run safety checks (clean tree, branch, req file exists)
  run.sh              Core pipeline: planning → implementation → verification → PR
  pr-create.sh        Build and submit GitHub PR with verification data + validation checklist
  init.sh             Interactive setup wizard — creates reqdrive.json + directories
  validate.sh         Config validation command
templates/
  reqdrive.json.example   Example configuration
tests/
  simple-test.sh      Primary test suite (152 tests, no external dependencies)
  run-tests.sh        Full test suite runner (requires bats-core)
  fixtures/           JSON fixtures for schema validation tests
  BEHAVIOR-SPEC.md    Behavioral contract for modules 1-4
skills/               Claude Code skills (design-to-prd, prd, project-journal, verification-workflow)
archive/              Archived v0.1.x code (parallel execution, worktrees, etc.)
```

## Pipeline Flow

1. **Pre-flight checks** — clean working tree, base branch exists, requirement file found
2. **Branch creation** — `reqdrive/<req-slug>` from base branch
3. **Phase 1: Planning** — Claude generates `prd.json` with user stories (up to 2 attempts)
4. **Phase 2: Implementation** — One Claude invocation per story, deterministic selection by priority. Per-iteration test execution and commit verification with result tracking.
5. **Phase 3: Verification** — Collect story stats, run final test suite, generate `verification-summary.json`. Failed verification forces draft PR.
6. **PR creation** — Push branch, create GitHub PR with verification data table + validation checklist from PRD

## Architectural Principles

- **Shell orchestrates, agent implements.** `run.sh` controls what story to work on, when to stop, and when to create the PR. Claude controls how to write the code. The shell selects stories via jq (`select_next_story`, line 347), builds prompts, and manages checkpoints. The agent never decides what to work on next. This separation prevents agent drift and makes the pipeline deterministic.

- **Stateless agent invocations.** Each Claude call is a fresh session with no memory of prior iterations. Context carries only through files: `progress.txt`, `prd.json`, and git history. This avoids context window exhaustion on long runs and makes each iteration independently reproducible.

- **Deterministic story selection.** `select_next_story` in `lib/run.sh:347` uses jq to pick the highest-priority incomplete story under the retry limit. The agent cannot cherry-pick easy stories or skip hard ones. Priority ordering is set during planning and respected during implementation.

- **Artifact format contracts.** JSON for machine state (`prd.json`, `checkpoint.json`, `run.json`, `iteration-N.summary.json`). Markdown for human/agent context (`progress.txt`, `prompt.md`). Schema validation in `lib/schema.sh` enforces the boundary. Breaking these formats breaks the pipeline.

- **Warn before enforce.** New checks start as logged warnings, graduate to checkpoint annotations, then promote to hard gates — only after observing real failure patterns. `testCommand` execution and commit verification currently run in observation mode (warn, don't abort). Schema validation is warn-only in most contexts. Don't make things strict without data.

- **Input sanitization is non-optional.** All user/agent content goes through `sanitize_for_prompt` (`lib/sanitize.sh:35`) before heredoc expansion. Labels go through `sanitize_label`. Content is scanned for shell injection, path traversal, and dangerous commands. This is a security boundary.

- **Bash for orchestration, other languages for API-heavy modules.** The CLI and pipeline stay in Bash — portable, minimal dependencies, runs on MSYS2/WSL/Linux. Future modules requiring binary data or complex API calls (e.g., vision-based QA with screenshots) should be Node or Python, called from the Bash orchestrator.

## Key Files and State

- **Config:** `reqdrive.json` at project root (found by walking up directory tree)
- **Run state:** `.reqdrive/runs/<req-slug>/` per requirement
  - `run.json` — lifecycle status, PID, timestamps, PR URL
  - `prd.json` — PRD with user stories (generated by agent)
  - `checkpoint.json` — resume state (iteration, branch, completed stories, commit SHA)
  - `progress.txt` — agent progress log
  - `prompt.md` — current iteration prompt
  - `iteration-N.log` — raw agent output per iteration
  - `iteration-N.summary.json` — structured summary per iteration
  - `iteration-N.test.log` — test command output per iteration
  - `verification-summary.json` — pipeline verification results (stories, tests, commits)
  - `verification.test.log` — final test suite output
  - `output.log` — stdout/stderr capture for `launch` command

## Commands

| Command | Description |
|---------|-------------|
| `init` | Interactive setup — creates `reqdrive.json` and directories |
| `run <REQ-ID>` | Foreground pipeline (supports `--interactive`, `--unsafe`, `--force`, `--resume`) |
| `launch <REQ-ID>` | Detached background run (nohup + `--unsafe`) |
| `status [REQ-ID]` | Show run status with PID liveness checking |
| `logs <REQ-ID>` | Tail `output.log` for a background run |
| `validate` | Validate `reqdrive.json` config |
| `migrate` | Add version fields to pre-0.3.0 configs/PRDs |
| `plan <REQ-ID>` | Standalone PRD generation (plan only, no implementation) |
| `orchestrate` | Coming soon — multi-requirement sequencing |

## Configuration (`reqdrive.json`)

| Field | Default | Type |
|-------|---------|------|
| `version` | — | string (`"0.3.0"`) |
| `requirementsDir` | `"docs/requirements"` | string |
| `testCommand` | `""` | string |
| `model` | `"claude-sonnet-4-20250514"` | string |
| `maxIterations` | `10` | number |
| `baseBranch` | `"main"` | string |
| `prLabels` | `["agent-generated"]` | array |
| `projectName` | `""` | string |
| `completionHook` | `""` | string (shell command) |

## Exit Codes

| Code | Name | Meaning |
|------|------|---------|
| 0 | `EXIT_SUCCESS` | Success |
| 1 | `EXIT_GENERAL_ERROR` | General error |
| 2 | `EXIT_MISSING_DEPENDENCY` | Missing required tool |
| 3 | `EXIT_CONFIG_ERROR` | Configuration error |
| 4 | `EXIT_GIT_ERROR` | Git operation failed |
| 5 | `EXIT_AGENT_ERROR` | Agent execution failed |
| 6 | `EXIT_PR_ERROR` | PR creation failed |
| 7 | `EXIT_USER_ABORT` | User aborted |
| 8 | `EXIT_PREFLIGHT_FAILED` | Pre-flight checks failed |

## Decision Log

> **Maintainers:** Add entries here when making significant architectural decisions.
> Future sessions will read this to avoid re-litigating settled questions.

- **[v0.2.0] Bash over Node/Python for the CLI.**
  **Why:** Portable (runs on MSYS2, WSL, Linux VPS), minimal deps (bash/jq/git/gh), no package manager needed. The user runs reqdrive across Windows and Linux environments.
  **Alternatives:** Node (adds npm), Python (adds venv/uv). Neither justified for shell orchestration.

- **[v0.2.0] Simplification from 17 scripts to 5 (the "Ralph pattern").**
  **Why:** v0.1.x had 1,679 lines across 13 library files with parallel execution, worktrees, dependency graphs, and a 30-field config. Most of it was unused complexity. The core insight: pipe prompts to Claude in a loop, let the shell control iteration. See `docs/SIMPLIFICATION-SUMMARY.md`.
  **Alternatives:** Keep the enterprise architecture. Rejected because it shipped nothing.

- **[v0.3.0] Per-requirement run directories (`.reqdrive/runs/<slug>/`).**
  **Why:** Isolates state per requirement. Enables concurrent status checking and future parallel runs. Previously all state lived in `.reqdrive/agent/`.
  **Alternatives:** Single shared directory (caused state collision between requirements).

- **[v0.2.0] Worktree support archived.**
  **Why:** Git worktrees added complexity (setup, cleanup, merge conflicts) for a feature that wasn't needed yet. Archived in `archive/v1-complex/lib/worktree.sh` for potential revival in `reqdrive orchestrate`.
  **Alternatives:** Keep worktrees. Rejected — sequential runs are sufficient for single-requirement pipeline.

- **[v0.3.0] Schema validation is warn-only by default.**
  **Why:** Follows "warn before enforce" principle. Strict validation would block the pipeline on minor schema issues the agent might fix in the next iteration. Graduated enforcement: log → annotate → gate.
  **Alternatives:** Strict validation. Rejected until false-positive rates are understood.

- **[v0.3.0] Unquoted heredoc for implementation prompts.**
  **Why:** `build_implementation_prompt` (`lib/run.sh:274`) uses `<<PROMPT_IMPL` (unquoted) to enable `${story_id}`, `${story_title}` expansion. The planning prompt uses `<<'PROMPT_PLAN'` (quoted) because it has no variables. Sanitization via `sanitize_for_prompt` mitigates expansion risks, but the structural pattern remains fragile.
  **Alternatives:** Quoted heredoc + `sed`/`envsubst` for variable injection. Deferred to Tier 2.

- **[v0.3.0] `launch` always uses `--unsafe` mode.**
  **Why:** Background runs can't prompt for permissions. `--unsafe` (`--dangerously-skip-permissions`) is the only viable mode for `nohup` detached execution.
  **Alternatives:** None — interactive permission prompts require a TTY.

- **[v0.3.0] One Claude invocation per story (stateless).**
  **Why:** Prevents context window exhaustion on long runs. Each iteration starts fresh. Context from prior iterations flows through files (`progress.txt`, git history), not conversation state.
  **Alternatives:** Single long-running session. Rejected — context limits cause degraded output quality.

- **[v0.3.0] jq for story selection, not agent choice.**
  **Why:** `select_next_story` uses jq to deterministically pick the next story by priority. If the agent chose, it could skip hard stories, reorder arbitrarily, or work on completed stories.
  **Alternatives:** Agent self-selects. Rejected — removes pipeline determinism.

- **[Audit] Vision-based QA agent should be Node/Python.**
  **Why:** Requires Playwright browser control and Claude Vision API with binary image data. Bash can't handle this. Called from Bash orchestrator as a subprocess.

- **[Audit] testCommand: warn-only, promote to hard gate after observing failure patterns.**
  **Why:** False positives in test execution (flaky tests, environment issues) would block the pipeline unnecessarily. Run tests, log results, don't abort — until failure rate data justifies enforcement.

## Roadmap

> **Maintainers:** Check off items as completed. Add new items as they're identified.
> Update this section whenever you finish work or make scope decisions.

### Tier 1 — Build Now (overnight reliability)

- [x] Wire up `testCommand` execution after implementation iterations — `lib/run.sh:813-821`, warn-only mode
- [x] Add post-iteration commit verification — `lib/run.sh:824-828`, checks commit message format
- [x] Add per-story retry limit — `select_next_story` respects `attempts` field, max via `maxStoryRetries` config (default 3), attempt counter incremented at `lib/run.sh:832`
- [x] Add `priority` field to schema validation — `lib/schema.sh:141`
- [x] Add commit SHA to checkpoint for resume safety — `lib/run.sh:80` saves SHA, line 128 verifies on resume
- [x] Implement `reqdrive plan` as standalone PRD generation — `bin/reqdrive:378-421`, fully functional

### Tier 2 — Build Next (trustworthy unattended merges)

- [x] Verification phase between implementation and PR creation — `lib/run.sh` Phase 3, generates `verification-summary.json`, runs final test suite, failed verification forces draft PR
- [x] Enriched PR body with test results, iteration log summary, and verification data — `lib/pr-create.sh` reads `verification-summary.json`, adds Pipeline Verification table
- [x] Per-iteration result tracking in `run.json` — `summary` field with tests/commits/stories counts via `RUN_SUMMARY_*` accumulators
- [ ] Post-iteration scope checking (diff analysis to detect out-of-scope changes)
- [ ] `reqdrive verify <REQ-ID>` as standalone command
- [ ] Heredoc structural fix — replace unquoted heredoc in `build_implementation_prompt` with quoted heredoc + explicit variable injection (`sed`/`envsubst`)

### Tier 3 — Build Eventually (full vision)

- [ ] Vision-based QA agent (Playwright + Claude Vision API) — Node/Python subprocess
- [ ] Multi-requirement parallelism via git worktrees (`reqdrive orchestrate`)
- [ ] PR rejection feedback loop (parse reviewer comments, re-run targeted stories)
- [ ] CI integration (poll `gh pr checks`, auto-fix on failure)
- [ ] Cost tracking and token budgets per requirement
- [ ] Adaptive retry policies based on historical success rates

## Development Conventions

- **Shell scripts:** Always use `set -euo pipefail` (entry) or `set -e` (libraries)
- **Syntax check:** Run `bash -n <file>` on all modified `.sh` files before committing
- **Tests:** Run `bash tests/simple-test.sh` — all 152 tests must pass
- **No Co-Authored-By** in commit messages
- **Schema version** `0.3.0` must be set in new JSON outputs (PRD, checkpoint, config)
- **Sanitization:** All user/agent-provided content must go through `sanitize_for_prompt` before heredoc expansion. Labels go through `sanitize_label`.
- **Preflight checks** run by default; `--force` bypasses them

## Testing

```bash
# Primary test suite (no external deps, runs everywhere)
bash tests/simple-test.sh

# Full suite with bats (if available)
bash tests/run-tests.sh
```

Tests cover: config loading, schema validation, sanitization, error codes, preflight checks, iteration summary extraction, prompt injection protection, and CLI behavior.

## Prerequisites

- `bash` 4.0+
- `jq`
- `git`
- `gh` (GitHub CLI, authenticated)
- `claude` (Claude Code CLI — only needed for `run`/`launch` commands)

## Security Notes

- `--unsafe` mode (`--dangerously-skip-permissions`) grants the agent unrestricted system access
- `launch` always uses `--unsafe` mode
- Requirement content is scanned for dangerous patterns (shell injection, path traversal)
- PRD-derived fields are sanitized before heredoc expansion to prevent injection
- Content validation is warn-only by default; use `--force` to bypass entirely

## Known Pitfalls

- **Heredoc quoting in implementation prompts.** `build_implementation_prompt` (`lib/run.sh:274`) uses an unquoted heredoc (`<<PROMPT_IMPL`) so `${story_id}` etc. expand. This means shell metacharacters in PRD-derived content can cause expansion bugs. `sanitize_for_prompt` escapes `$` and backticks, but the structural risk remains. The planning prompt (`lib/run.sh:187`) uses a quoted heredoc (`<<'PROMPT_PLAN'`) because it has no variables — this is the safe pattern. The fix (Tier 2) is to use quoted heredocs everywhere and inject variables via `sed`.

- **`testCommand` is warn-only.** `testCommand` is auto-detected during `init` and now executed after each implementation iteration (`lib/run.sh:813-821`), but failures only produce warnings — they don't abort or retry. This is intentional (observe before enforce). Treat test failures in `iteration-N.test.log` as signals requiring human review until the verification phase is built.

- **Agent self-reporting is not authoritative.** The pipeline trusts the agent's `passes: true` markers in `prd.json` and iteration summary self-reports. The agent can (and sometimes does) mark stories complete without tests passing. Until the Tier 2 verification phase exists, treat agent self-reports as advisory. The post-iteration commit check (`lib/run.sh:824-828`) provides a minimal independent signal.

- **Platform differences (MSYS2/WSL/Linux).** The user runs reqdrive on Windows (MSYS2/Git Bash), WSL, and Linux VPS. Known issues: `nohup` behavior varies in MSYS2 (process tracking less reliable), `realpath` may not exist (used in `sanitize.sh:123`), `date -Iseconds` format varies across platforms, signal trapping (INT/TERM/HUP) is less reliable under MSYS2. The test suite runs on all platforms without platform-conditional logic.

- **`launch` and `--unsafe` are inseparable.** `launch` always runs with `--dangerously-skip-permissions` (`bin/reqdrive:486`). This gives the agent unrestricted system access. Any changes to agent invocation must preserve the user's ability to choose between `--interactive` (foreground) and `--unsafe` (background/launch). Never default a foreground `run` to unsafe.

- **Schema validation is intentionally lenient.** Don't "fix" validation by making it strict. The graduated enforcement path is: log warnings → annotate checkpoints → hard gate. PRD structure is validated but not content quality — a PRD with one story titled "Do everything" passes validation. Until a quality rubric is integrated, human review of `prd.json` after `reqdrive plan` is recommended.

- **The `archive/` directory is not dead code.** Contains v0.1.x code including parallel execution (`orchestrate.sh`), worktree management (`worktree.sh`), dependency graphs (`deps.sh`), and a verification module (`verify.sh`). Archived during v0.2.0 simplification, not deleted, because the ideas may be revisited for `reqdrive orchestrate`. Don't delete it. Don't resurrect it without reading `docs/SIMPLIFICATION-SUMMARY.md`.

- **No file locking on run directories.** Two concurrent `reqdrive run` commands targeting the same REQ-ID will race on shared files in `.reqdrive/runs/<slug>/`. The PID check in `launch` prevents double-launching, but there's no lock on the run directory itself.
