#!/usr/bin/env bash
# reqdrive — Requirements-driven development pipeline
# Dispatches subcommands to lib/ scripts.

set -euo pipefail

REQDRIVE_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
export REQDRIVE_ROOT

# ── Dependency check ──────────────────────────────────────────────────
check_tool() {
  if ! command -v "$1" &>/dev/null; then
    echo "ERROR: Required tool '$1' not found. Please install it." >&2
    exit 1
  fi
}

for tool in jq git gh claude; do
  check_tool "$tool"
done

# ── Source config loader ──────────────────────────────────────────────
source "$REQDRIVE_ROOT/lib/config.sh"

# ── Usage ─────────────────────────────────────────────────────────────
usage() {
  cat <<'EOF'
reqdrive — Requirements-driven development pipeline

Usage:
  reqdrive init                    Scaffold manifest + agent prompt
  reqdrive run REQ-01 REQ-03       Run specific requirements
  reqdrive run --all               Run all (respecting deps)
  reqdrive run --next              Auto-detect next available
  reqdrive status [run-id]         Show run status
  reqdrive clean                   Remove worktrees
  reqdrive validate                Validate manifest
  reqdrive deps                    Print dependency graph

Options:
  -h, --help                       Show this help
  -v, --version                    Show version

Prerequisites: bash, jq, git, gh, claude
EOF
}

VERSION="0.1.0"

# ── Dispatch ──────────────────────────────────────────────────────────
_reqdrive_cmd="${1:-}"
shift || true

# Save positional params for sourced scripts
_reqdrive_args=("$@")

_reqdrive_dispatch() {
  local script="$1"
  # Set positional params for the sourced script
  set -- "${_reqdrive_args[@]}"
  source "$REQDRIVE_ROOT/lib/$script"
}

case "$_reqdrive_cmd" in
  init)
    _reqdrive_dispatch "init.sh"
    ;;
  run)
    reqdrive_load_config
    _reqdrive_dispatch "orchestrate.sh"
    ;;
  status)
    reqdrive_load_config
    _reqdrive_dispatch "status.sh"
    ;;
  clean)
    reqdrive_load_config
    _reqdrive_dispatch "clean.sh"
    ;;
  validate)
    reqdrive_load_config_path
    _reqdrive_dispatch "validate.sh"
    ;;
  deps)
    reqdrive_load_config
    _reqdrive_dispatch "deps.sh"
    ;;
  -v|--version)
    echo "reqdrive $VERSION"
    ;;
  -h|--help|"")
    usage
    ;;
  *)
    echo "Unknown command: $_reqdrive_cmd" >&2
    echo "Run 'reqdrive --help' for usage." >&2
    exit 1
    ;;
esac
