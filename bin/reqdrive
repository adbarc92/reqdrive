#!/usr/bin/env bash
# reqdrive - Requirements-driven development pipeline
# Simple CLI for running requirements through an AI agent to PRs

set -euo pipefail

REQDRIVE_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
export REQDRIVE_ROOT

VERSION="0.3.0"

# Source error codes
source "$REQDRIVE_ROOT/lib/errors.sh"

# ── Dependency check ──────────────────────────────────────────────────────────

check_tool() {
  if ! command -v "$1" &>/dev/null; then
    echo "ERROR: Required tool '$1' not found." >&2
    exit "$EXIT_MISSING_DEPENDENCY"
  fi
}

# Check tools that are always required
for tool in jq git gh; do
  check_tool "$tool"
done

# Check claude only when needed (deferred to run command)
check_claude() {
  if ! command -v claude &>/dev/null; then
    echo "ERROR: Required tool 'claude' not found." >&2
    echo "" >&2
    echo "The 'claude' CLI is required to run the agent pipeline." >&2
    echo "Install it from: https://github.com/anthropics/claude-code" >&2
    exit "$EXIT_MISSING_DEPENDENCY"
  fi
}

# ── Usage ─────────────────────────────────────────────────────────────────────

usage() {
  cat <<'EOF'
reqdrive - Requirements to Pull Requests via AI

Usage:
  reqdrive init              Create reqdrive.json config
  reqdrive run <REQ-ID>      Run pipeline for a requirement
  reqdrive validate          Validate config
  reqdrive status            Show iteration progress and story completion
  reqdrive migrate           Add version fields to existing configs
  reqdrive plan              Generate PRD from requirement (coming soon)
  reqdrive orchestrate       Run multiple requirements in sequence (coming soon)

Run Options:
  -i, --interactive          Run in interactive mode (default, safer)
  --unsafe                   Skip permission prompts (use with caution)
  --force                    Skip pre-flight checks (not recommended)
  --resume                   Resume from last checkpoint

Examples:
  reqdrive init
  reqdrive run REQ-01
  reqdrive run REQ-01 --unsafe    # Non-interactive mode
  reqdrive run REQ-01 --resume    # Resume interrupted run

Options:
  -h, --help     Show this help
  -v, --version  Show version

Prerequisites: bash, jq, git, gh, claude
EOF
}

# ── Commands ──────────────────────────────────────────────────────────────────

cmd_init() {
  source "$REQDRIVE_ROOT/lib/init.sh"
}

cmd_run() {
  # Check for claude binary (only needed for run command)
  check_claude

  # Parse arguments
  local req_id=""
  export REQDRIVE_INTERACTIVE="true"
  export REQDRIVE_FORCE="false"
  export REQDRIVE_RESUME="false"

  while [ $# -gt 0 ]; do
    case "$1" in
      -i|--interactive)
        REQDRIVE_INTERACTIVE="true"
        shift
        ;;
      --unsafe|--dangerously-skip-permissions)
        REQDRIVE_INTERACTIVE="false"
        shift
        ;;
      --force)
        REQDRIVE_FORCE="true"
        shift
        ;;
      --resume)
        REQDRIVE_RESUME="true"
        shift
        ;;
      -*)
        echo "Unknown option: $1" >&2
        echo "Run 'reqdrive run --help' for usage." >&2
        exit "$EXIT_GENERAL_ERROR"
        ;;
      *)
        if [ -z "$req_id" ]; then
          req_id="$1"
        else
          echo "Unexpected argument: $1" >&2
          exit "$EXIT_GENERAL_ERROR"
        fi
        shift
        ;;
    esac
  done

  if [ -z "$req_id" ]; then
    echo "Usage: reqdrive run <REQ-ID> [options]" >&2
    echo "Example: reqdrive run REQ-01" >&2
    echo "" >&2
    echo "Options:" >&2
    echo "  -i, --interactive  Run in interactive mode (default)" >&2
    echo "  --unsafe           Skip permission prompts" >&2
    echo "  --force            Skip pre-flight checks" >&2
    echo "  --resume           Resume from checkpoint" >&2
    exit "$EXIT_GENERAL_ERROR"
  fi

  # Show warning for unsafe mode
  if [ "$REQDRIVE_INTERACTIVE" = "false" ]; then
    echo ""
    echo "╔══════════════════════════════════════════════════════════════════╗"
    echo "║  WARNING: Running in UNSAFE mode (--dangerously-skip-permissions) ║"
    echo "║                                                                   ║"
    echo "║  The AI agent will have unrestricted access to:                   ║"
    echo "║  - Execute any shell commands                                     ║"
    echo "║  - Modify any files in the repository                             ║"
    echo "║  - Make network requests                                          ║"
    echo "║                                                                   ║"
    echo "║  Only use this mode if you trust the requirement content.         ║"
    echo "╚══════════════════════════════════════════════════════════════════╝"
    echo ""

    # If running in a TTY, ask for confirmation
    if [ -t 0 ]; then
      read -p "Continue in unsafe mode? [y/N] " -n 1 -r
      echo ""
      if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Aborted."
        exit "$EXIT_USER_ABORT"
      fi
    fi
  fi

  source "$REQDRIVE_ROOT/lib/config.sh"
  reqdrive_load_config

  source "$REQDRIVE_ROOT/lib/run.sh"
  run_pipeline "$req_id"
}

cmd_validate() {
  source "$REQDRIVE_ROOT/lib/config.sh"
  reqdrive_load_config

  source "$REQDRIVE_ROOT/lib/validate.sh"
}

cmd_status() {
  source "$REQDRIVE_ROOT/lib/config.sh"
  reqdrive_load_config

  local agent_dir="$REQDRIVE_PROJECT_ROOT/.reqdrive/agent"
  local prd_file="$agent_dir/prd.json"

  echo "═══════════════════════════════════════════════════════"
  echo "  reqdrive status"
  echo "═══════════════════════════════════════════════════════"
  echo ""

  # Show PRD story completion
  if [ -f "$prd_file" ]; then
    local project source_req
    project=$(jq -r '.project // "unknown"' "$prd_file")
    source_req=$(jq -r '.sourceReq // "unknown"' "$prd_file")
    local total passed remaining
    total=$(jq '.userStories | length' "$prd_file")
    passed=$(jq '[.userStories[] | select(.passes == true)] | length' "$prd_file")
    remaining=$((total - passed))

    echo "PRD: $project ($source_req)"
    echo "Stories: $passed/$total complete ($remaining remaining)"
    echo ""
    echo "  ID       Status  Title"
    echo "  ──────── ──────  ─────────────────────────────────"
    jq -r '.userStories[] | "  \(.id)   \(if .passes then "DONE" else "TODO" end)    \(.title)"' "$prd_file"
  else
    echo "No prd.json found. Pipeline has not been run yet."
  fi

  echo ""

  # Show iteration summaries
  local summaries
  summaries=$(ls "$agent_dir"/iteration-*.summary.json 2>/dev/null || true)

  if [ -n "$summaries" ]; then
    echo "Iteration History:"
    echo "  Iter  Story     Action       Notes"
    echo "  ────  ────────  ───────────  ─────────────────────────────────"

    for f in $summaries; do
      local iter_num
      iter_num=$(basename "$f" | sed 's/iteration-//;s/\.summary\.json//')
      local story_id action notes
      story_id=$(jq -r '.storyId // "-"' "$f")
      action=$(jq -r '.action // "-"' "$f")
      notes=$(jq -r '.notes // ""' "$f" | head -c 40)
      printf "  %-4s  %-8s  %-11s  %s\n" "$iter_num" "$story_id" "$action" "$notes"
    done
  else
    echo "No iteration summaries found."
  fi

  echo ""
}

cmd_migrate() {
  source "$REQDRIVE_ROOT/lib/schema.sh"
  source "$REQDRIVE_ROOT/lib/config.sh"

  local manifest
  manifest=$(reqdrive_find_manifest 2>/dev/null) || {
    echo "No reqdrive.json found. Nothing to migrate." >&2
    exit "$EXIT_CONFIG_ERROR"
  }

  local project_root
  project_root="$(dirname "$manifest")"

  echo "Migrating to schema version $REQDRIVE_SCHEMA_VERSION..."

  # Migrate reqdrive.json
  if [ -f "$manifest" ]; then
    local has_version
    has_version=$(jq -r '.version // empty' "$manifest" 2>/dev/null)
    if [ -z "$has_version" ]; then
      local tmp
      tmp=$(jq --arg v "$REQDRIVE_SCHEMA_VERSION" '. + {version: $v}' "$manifest")
      echo "$tmp" > "$manifest"
      echo "  Updated: reqdrive.json (added version $REQDRIVE_SCHEMA_VERSION)"
    else
      echo "  Skipped: reqdrive.json (already has version $has_version)"
    fi
  fi

  # Migrate prd.json if it exists
  local prd_file="$project_root/.reqdrive/agent/prd.json"
  if [ -f "$prd_file" ]; then
    local has_version
    has_version=$(jq -r '.version // empty' "$prd_file" 2>/dev/null)
    if [ -z "$has_version" ]; then
      local tmp
      tmp=$(jq --arg v "$REQDRIVE_SCHEMA_VERSION" '. + {version: $v}' "$prd_file")
      echo "$tmp" > "$prd_file"
      echo "  Updated: .reqdrive/agent/prd.json (added version $REQDRIVE_SCHEMA_VERSION)"
    else
      echo "  Skipped: .reqdrive/agent/prd.json (already has version $has_version)"
    fi
  fi

  echo "Migration complete."
}

cmd_plan() {
  echo "reqdrive plan - Generate and validate PRD from requirement"
  echo ""
  echo "This command will analyze a requirement file and generate a structured"
  echo "PRD (Product Requirements Document) before running the agent pipeline."
  echo ""
  echo "Coming soon. For now, the agent generates the PRD during 'reqdrive run'."
}

cmd_orchestrate() {
  echo "reqdrive orchestrate - Run multiple requirements in sequence"
  echo ""
  echo "This command will process multiple requirements in dependency order,"
  echo "running each through the pipeline sequentially."
  echo ""
  echo "Coming soon. For now, run individual requirements with 'reqdrive run <REQ-ID>'."
}

# ── Dispatch ──────────────────────────────────────────────────────────────────

case "${1:-}" in
  init)
    cmd_init
    ;;
  run)
    shift
    cmd_run "$@"
    ;;
  validate)
    cmd_validate
    ;;
  status)
    cmd_status
    ;;
  migrate)
    cmd_migrate
    ;;
  plan)
    cmd_plan
    ;;
  orchestrate)
    cmd_orchestrate
    ;;
  -v|--version)
    echo "reqdrive $VERSION"
    ;;
  -h|--help|"")
    usage
    ;;
  *)
    echo "Unknown command: $1" >&2
    echo "Run 'reqdrive --help' for usage." >&2
    exit "$EXIT_GENERAL_ERROR"
    ;;
esac
