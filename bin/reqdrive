#!/usr/bin/env bash
# reqdrive - Requirements-driven development pipeline
# Simple CLI for running requirements through an AI agent to PRs

set -euo pipefail

REQDRIVE_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
export REQDRIVE_ROOT

VERSION="0.2.0"

# ── Dependency check ──────────────────────────────────────────────────

check_tool() {
  if ! command -v "$1" &>/dev/null; then
    echo "ERROR: Required tool '$1' not found." >&2
    exit 1
  fi
}

for tool in jq git gh claude; do
  check_tool "$tool"
done

# ── Usage ─────────────────────────────────────────────────────────────

usage() {
  cat <<'EOF'
reqdrive - Requirements to Pull Requests via AI

Usage:
  reqdrive init              Create reqdrive.json config
  reqdrive run <REQ-ID>      Run pipeline for a requirement
  reqdrive validate          Validate config

Examples:
  reqdrive init
  reqdrive run REQ-01
  reqdrive run req-02

Options:
  -h, --help     Show this help
  -v, --version  Show version

Prerequisites: bash, jq, git, gh, claude
EOF
}

# ── Commands ──────────────────────────────────────────────────────────

cmd_init() {
  source "$REQDRIVE_ROOT/lib/init.sh"
}

cmd_run() {
  local req_id="${1:-}"

  if [ -z "$req_id" ]; then
    echo "Usage: reqdrive run <REQ-ID>" >&2
    echo "Example: reqdrive run REQ-01" >&2
    exit 1
  fi

  source "$REQDRIVE_ROOT/lib/config.sh"
  reqdrive_load_config

  source "$REQDRIVE_ROOT/lib/run.sh"
  run_pipeline "$req_id"
}

cmd_validate() {
  source "$REQDRIVE_ROOT/lib/config.sh"
  reqdrive_load_config

  source "$REQDRIVE_ROOT/lib/validate.sh"
}

# ── Dispatch ──────────────────────────────────────────────────────────

case "${1:-}" in
  init)
    cmd_init
    ;;
  run)
    shift
    cmd_run "$@"
    ;;
  validate)
    cmd_validate
    ;;
  -v|--version)
    echo "reqdrive $VERSION"
    ;;
  -h|--help|"")
    usage
    ;;
  *)
    echo "Unknown command: $1" >&2
    echo "Run 'reqdrive --help' for usage." >&2
    exit 1
    ;;
esac
