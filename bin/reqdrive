#!/usr/bin/env bash
# reqdrive - Requirements-driven development pipeline
# Simple CLI for running requirements through an AI agent to PRs

set -euo pipefail

REQDRIVE_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
export REQDRIVE_ROOT

VERSION="0.3.0"

# Source error codes
source "$REQDRIVE_ROOT/lib/errors.sh"

# ── Dependency check ──────────────────────────────────────────────────────────

check_tool() {
  if ! command -v "$1" &>/dev/null; then
    echo "ERROR: Required tool '$1' not found." >&2
    exit "$EXIT_MISSING_DEPENDENCY"
  fi
}

# Check tools that are always required
for tool in jq git gh; do
  check_tool "$tool"
done

# Check claude only when needed (deferred to run command)
check_claude() {
  if ! command -v claude &>/dev/null; then
    echo "ERROR: Required tool 'claude' not found." >&2
    echo "" >&2
    echo "The 'claude' CLI is required to run the agent pipeline." >&2
    echo "Install it from: https://github.com/anthropics/claude-code" >&2
    exit "$EXIT_MISSING_DEPENDENCY"
  fi
}

# ── Usage ─────────────────────────────────────────────────────────────────────

usage() {
  cat <<'EOF'
reqdrive - Requirements to Pull Requests via AI

Usage:
  reqdrive init              Create reqdrive.json config
  reqdrive run <REQ-ID>      Run pipeline for a requirement
  reqdrive validate          Validate config
  reqdrive migrate           Add version fields to existing configs

Run Options:
  -i, --interactive          Run in interactive mode (default, safer)
  --unsafe                   Skip permission prompts (use with caution)
  --force                    Skip pre-flight checks (not recommended)
  --resume                   Resume from last checkpoint

Examples:
  reqdrive init
  reqdrive run REQ-01
  reqdrive run REQ-01 --unsafe    # Non-interactive mode
  reqdrive run REQ-01 --resume    # Resume interrupted run

Options:
  -h, --help     Show this help
  -v, --version  Show version

Prerequisites: bash, jq, git, gh, claude
EOF
}

# ── Commands ──────────────────────────────────────────────────────────────────

cmd_init() {
  source "$REQDRIVE_ROOT/lib/init.sh"
}

cmd_run() {
  # Check for claude binary (only needed for run command)
  check_claude

  # Parse arguments
  local req_id=""
  export REQDRIVE_INTERACTIVE="true"
  export REQDRIVE_FORCE="false"
  export REQDRIVE_RESUME="false"

  while [ $# -gt 0 ]; do
    case "$1" in
      -i|--interactive)
        REQDRIVE_INTERACTIVE="true"
        shift
        ;;
      --unsafe|--dangerously-skip-permissions)
        REQDRIVE_INTERACTIVE="false"
        shift
        ;;
      --force)
        REQDRIVE_FORCE="true"
        shift
        ;;
      --resume)
        REQDRIVE_RESUME="true"
        shift
        ;;
      -*)
        echo "Unknown option: $1" >&2
        echo "Run 'reqdrive run --help' for usage." >&2
        exit "$EXIT_GENERAL_ERROR"
        ;;
      *)
        if [ -z "$req_id" ]; then
          req_id="$1"
        else
          echo "Unexpected argument: $1" >&2
          exit "$EXIT_GENERAL_ERROR"
        fi
        shift
        ;;
    esac
  done

  if [ -z "$req_id" ]; then
    echo "Usage: reqdrive run <REQ-ID> [options]" >&2
    echo "Example: reqdrive run REQ-01" >&2
    echo "" >&2
    echo "Options:" >&2
    echo "  -i, --interactive  Run in interactive mode (default)" >&2
    echo "  --unsafe           Skip permission prompts" >&2
    echo "  --force            Skip pre-flight checks" >&2
    echo "  --resume           Resume from checkpoint" >&2
    exit "$EXIT_GENERAL_ERROR"
  fi

  # Show warning for unsafe mode
  if [ "$REQDRIVE_INTERACTIVE" = "false" ]; then
    echo ""
    echo "╔══════════════════════════════════════════════════════════════════╗"
    echo "║  WARNING: Running in UNSAFE mode (--dangerously-skip-permissions) ║"
    echo "║                                                                   ║"
    echo "║  The AI agent will have unrestricted access to:                   ║"
    echo "║  - Execute any shell commands                                     ║"
    echo "║  - Modify any files in the repository                             ║"
    echo "║  - Make network requests                                          ║"
    echo "║                                                                   ║"
    echo "║  Only use this mode if you trust the requirement content.         ║"
    echo "╚══════════════════════════════════════════════════════════════════╝"
    echo ""

    # If running in a TTY, ask for confirmation
    if [ -t 0 ]; then
      read -p "Continue in unsafe mode? [y/N] " -n 1 -r
      echo ""
      if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Aborted."
        exit "$EXIT_USER_ABORT"
      fi
    fi
  fi

  source "$REQDRIVE_ROOT/lib/config.sh"
  reqdrive_load_config

  source "$REQDRIVE_ROOT/lib/run.sh"
  run_pipeline "$req_id"
}

cmd_validate() {
  source "$REQDRIVE_ROOT/lib/config.sh"
  reqdrive_load_config

  source "$REQDRIVE_ROOT/lib/validate.sh"
}

cmd_migrate() {
  source "$REQDRIVE_ROOT/lib/schema.sh"
  source "$REQDRIVE_ROOT/lib/config.sh"

  local manifest
  manifest=$(reqdrive_find_manifest 2>/dev/null) || {
    echo "No reqdrive.json found. Nothing to migrate." >&2
    exit "$EXIT_CONFIG_ERROR"
  }

  local project_root
  project_root="$(dirname "$manifest")"

  echo "Migrating to schema version $REQDRIVE_SCHEMA_VERSION..."

  # Migrate reqdrive.json
  if [ -f "$manifest" ]; then
    local has_version
    has_version=$(jq -r '.version // empty' "$manifest" 2>/dev/null)
    if [ -z "$has_version" ]; then
      local tmp
      tmp=$(jq --arg v "$REQDRIVE_SCHEMA_VERSION" '. + {version: $v}' "$manifest")
      echo "$tmp" > "$manifest"
      echo "  Updated: reqdrive.json (added version $REQDRIVE_SCHEMA_VERSION)"
    else
      echo "  Skipped: reqdrive.json (already has version $has_version)"
    fi
  fi

  # Migrate prd.json if it exists
  local prd_file="$project_root/.reqdrive/agent/prd.json"
  if [ -f "$prd_file" ]; then
    local has_version
    has_version=$(jq -r '.version // empty' "$prd_file" 2>/dev/null)
    if [ -z "$has_version" ]; then
      local tmp
      tmp=$(jq --arg v "$REQDRIVE_SCHEMA_VERSION" '. + {version: $v}' "$prd_file")
      echo "$tmp" > "$prd_file"
      echo "  Updated: .reqdrive/agent/prd.json (added version $REQDRIVE_SCHEMA_VERSION)"
    else
      echo "  Skipped: .reqdrive/agent/prd.json (already has version $has_version)"
    fi
  fi

  echo "Migration complete."
}

# ── Dispatch ──────────────────────────────────────────────────────────────────

case "${1:-}" in
  init)
    cmd_init
    ;;
  run)
    shift
    cmd_run "$@"
    ;;
  validate)
    cmd_validate
    ;;
  migrate)
    cmd_migrate
    ;;
  -v|--version)
    echo "reqdrive $VERSION"
    ;;
  -h|--help|"")
    usage
    ;;
  *)
    echo "Unknown command: $1" >&2
    echo "Run 'reqdrive --help' for usage." >&2
    exit "$EXIT_GENERAL_ERROR"
    ;;
esac
